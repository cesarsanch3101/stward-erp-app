üìò Manual de Arranque (Actualizado para Equipo Nuevo)
Si hoy le pasas este c√≥digo a otro desarrollador (o lo clonas en otra PC), estos son los pasos exactos para que funcione con todas las modificaciones de seguridad y base de datos que hemos hecho.

1. Configuraci√≥n de Secretos
En la ra√≠z del proyecto, crea el archivo .env (que no se sube a git):

Ini, TOML

DEBUG=True
SECRET_KEY=clave-secreta-desarrollo-123
ALLOWED_HOSTS=localhost,127.0.0.1,.localhost,web,172.16.1.18

# Base de Datos (Interna de Docker)
DB_NAME=stward_db
DB_USER=stward_user
DB_PASSWORD=stward_password
DB_HOST=db
DB_PORT=5432

# Redis & Celery
CELERY_BROKER=redis://redis:6379/0
CELERY_BACKEND=redis://redis:6379/0
2. Levantar Infraestructura
En la terminal ra√≠z:

Bash

# 1. Construir y levantar (asegura que tome los cambios de Dockerfile)
docker-compose up --build -d

# 2. Verificar que db, redis y web est√©n "Up"
docker-compose ps
3. Aplicar Cambios de Base de Datos (Migraciones)
OJO: Como agregamos campos nuevos a Sales y Purchasing en los pasos anteriores, esto es obligatorio.

Bash

# 1. Crear migraciones pendientes para Sales (RUC, DV, Impuestos)
docker-compose exec web python manage.py makemigrations sales

# 2. Crear migraciones para Purchasing (si hubiera cambios pendientes)
docker-compose exec web python manage.py makemigrations purchasing

# 3. Aplicar migraciones al esquema P√∫blico (Users, Clients)
docker-compose exec web python manage.py migrate_schemas --shared

# 4. Aplicar migraciones a los Inquilinos (Tesla, etc.)
docker-compose exec web python manage.py migrate_schemas --tenant
4. Inicializar Datos (Si es una instalaci√≥n limpia)
Si la base de datos es nueva, no tendr√°s ni empresa ni usuario. Ejecuta este script de una vez:

Bash

docker-compose exec web python manage.py shell -c "
from tenants.models import Company, Domain
from django.contrib.auth.models import User
from django_tenants.utils import schema_context

# 1. Crear Tenant P√∫blico
if not Company.objects.filter(schema_name='public').exists():
    public = Company(schema_name='public', name='Stward Public')
    public.save()
    Domain.objects.create(domain='localhost', tenant=public, is_primary=True)
    print('‚úÖ Tenant Public creado')

# 2. Crear Tenant Demo (Tesla)
if not Company.objects.filter(schema_name='tesla').exists():
    tesla = Company(schema_name='tesla', name='Tesla Motors')
    tesla.save()
    # Aseg√∫rate que este dominio coincida con tu allowedHosts de Vite
    Domain.objects.create(domain='tesla.localhost', tenant=tesla, is_primary=True)
    print('‚úÖ Tenant Tesla creado')

# 3. Crear Admin Global
with schema_context('public'):
    if not User.objects.filter(username='admin').exists():
        User.objects.create_superuser('admin', 'admin@stward.com', 'admin123')
        print('‚úÖ Usuario Admin creado (Pass: admin123)')
"
5. Arrancar Frontend
En otra terminal, dentro de la carpeta frontend:

Bash

npm install
npm run dev
Prueba de Fuego:

Entra a http://localhost:5173.

Login con admin / admin123.

Ve a Ventas -> Crea un Cliente -> Crea una Orden.

Si funciona sin errores rojos en consola, ¬°est√°s listo para continuar



Resumen: Pasos para Arrancar en Otro Equipo
Tal como pediste, aqu√≠ tienes la Gu√≠a Definitiva de Despliegue para cuando lleves este c√≥digo a otra m√°quina limpia. Guarda esto como LEER_ANTES_DE_ARRANCAR.txt.

Instalar Prerrequisitos:

Docker Desktop (corriendo).

Node.js (v18+).

Clonar el Proyecto:

git clone <tu-repo>

cd stward-erp-app

Crear archivo de Secretos (.env):

Crea un archivo .env en la ra√≠z con:

Ini, TOML

DEBUG=True
SECRET_KEY=dev-secret-123
ALLOWED_HOSTS=localhost,127.0.0.1,.localhost,web,tesla.localhost
DB_NAME=stward_db
DB_USER=stward_user
DB_PASSWORD=stward_password
DB_HOST=db
DB_PORT=5432
CELERY_BROKER=redis://redis:6379/0
CELERY_BACKEND=redis://redis:6379/0
Levantar Backend (Docker):

docker-compose up --build -d

Esperar 1 min a que la base de datos inicie.

Inicializar Base de Datos (Solo la primera vez):

docker-compose exec web python manage.py migrate_schemas --shared

(Ejecuta el script de Python de arriba para crear Tenants y Admin).

Levantar Frontend:

cd frontend

npm install

npm run dev

Usar: Entrar a http://tesla.localhost:5173


üìò Manual de Arranque Definitivo: Stward ERP1. Prerrequisitos del SistemaAntes de tocar el c√≥digo, aseg√∫rate de tener instalado:Docker Desktop: (Debe estar corriendo).Node.js (v18+): Para el frontend.Git: Para clonar el repositorio.2. Configuraci√≥n de Secretos (Backend)El error m√°s com√∫n es olvidar las variables de entorno, lo que causa fallos de conexi√≥n a la base de datos o errores de DisallowedHost.Ve a la carpeta ra√≠z del proyecto (donde est√° manage.py).Crea un archivo llamado .env.Copia y pega el siguiente contenido exacto. Nota: He incluido tesla.localhost en ALLOWED_HOSTS para evitar bloqueos del framework.Ini, TOML# --- ARCHIVO .env ---
DEBUG=True
SECRET_KEY=clave-secreta-desarrollo-stward-erp-123

# ¬°CR√çTICO! Estos dominios permiten que Django acepte la petici√≥n.
# Si intentas acceder desde una IP o dominio no listado aqu√≠, recibir√°s Error 400.
ALLOWED_HOSTS=localhost,127.0.0.1,.localhost,web,172.16.1.18,tesla.localhost

# Base de Datos (Conexi√≥n interna de Docker)
DB_NAME=stward_db
DB_USER=stward_user
DB_PASSWORD=stward_password
DB_HOST=db
DB_PORT=5432

# Redis & Celery (Para tareas as√≠ncronas e IA)
CELERY_BROKER=redis://redis:6379/0
CELERY_BACKEND=redis://redis:6379/0
3. Infraestructura y Base de Datos (Docker)Levantaremos los contenedores y configuraremos los esquemas de la base de datos PostgreSQL. Esta arquitectura usa esquemas separados, por lo que las migraciones tradicionales no bastan.Paso 3.1: Levantar ContenedoresEn la terminal (ra√≠z del proyecto):Bash# Construye las im√°genes y levanta los servicios en segundo plano
docker-compose up --build -d

# Verifica que 'stward_web', 'stward_db' y 'stward_redis' est√©n en estado 'Up'
docker-compose ps
Paso 3.2: Migraciones Multi-TenantDebemos crear las tablas tanto en el esquema public (compartido) como en los esquemas de inquilinos.Bash# 1. Crear archivos de migraci√≥n pendientes (si los hubiera)
docker-compose exec web python manage.py makemigrations

# 2. Aplicar migraciones al esquema 'public' (Gesti√≥n de usuarios globales y tenants)
docker-compose exec web python manage.py migrate_schemas --shared

# 3. Aplicar migraciones a los esquemas de inquilinos (Tablas de negocio: ventas, inventario, etc.)
docker-compose exec web python manage.py migrate_schemas --tenant
[Fuente: manual de arranque.txt - Secci√≥n 3]4. Inicializaci√≥n de Datos (Tenant & Admin)Si el sistema est√° limpio, no podr√°s loguearte. Necesitamos crear la empresa (Tenant) y el usuario administrador mediante un script.Ejecuta este comando en tu terminal para inyectar los datos semilla:Bashdocker-compose exec web python manage.py shell -c "
from tenants.models import Company, Domain
from django.contrib.auth.models import User
from django_tenants.utils import schema_context

# 1. Crear Tenant P√∫blico (Necesario para el enrutamiento base)
if not Company.objects.filter(schema_name='public').exists():
    public = Company(schema_name='public', name='Stward Public')
    public.save()
    Domain.objects.create(domain='localhost', tenant=public, is_primary=True)
    print('‚úÖ Tenant Public creado')

# 2. Crear Tenant Demo 'Tesla' (Aqu√≠ vivir√°n los datos de prueba)
if not Company.objects.filter(schema_name='tesla').exists():
    tesla = Company(schema_name='tesla', name='Tesla Motors')
    tesla.save()
    # ¬°IMPORTANTE! Este dominio debe coincidir con lo que pongas en el navegador
    Domain.objects.create(domain='tesla.localhost', tenant=tesla, is_primary=True)
    print('‚úÖ Tenant Tesla creado')

# 3. Crear Superusuario Admin Global
# Lo creamos dentro del esquema p√∫blico para que tenga acceso global
with schema_context('public'):
    if not User.objects.filter(username='admin').exists():
        User.objects.create_superuser('admin', 'admin@stward.com', 'admin123')
        print('‚úÖ Usuario Admin creado: admin / admin123')
"
5. Arranque del Frontend (Vite)El frontend debe configurarse para permitir subdominios locales (como tesla.localhost).Abre una nueva terminal.Navega a la carpeta del frontend: cd frontend.Instala dependencias y corre el servidor:Bashnpm install
npm run dev
Nota t√©cnica: La configuraci√≥n de vite.config.js ya incluye allowedHosts: ['.localhost'] para permitir el acceso mediante subdominios locales.6. Prueba de Acceso y Credenciales (¬°Crucial!)Aqu√≠ es donde ocurren el 90% de los errores "No funciona".‚ùå Forma INCORRECTA de acceder:http://localhost:5173 -> Error: Te llevar√° al esquema public, que no tiene las apps de negocio (Ventas, Inventario) instaladas. Ver√°s errores 404 en las llamadas a la API de negocio.‚úÖ Forma CORRECTA de acceder (Dominio Aceptado):Debes acceder usando el subdominio del inquilino que creamos (tesla).Abre tu navegador (Chrome/Edge/Firefox).Navega a: http://tesla.localhost:5173Login:Usuario: adminContrase√±a: admin123Si todo est√° correcto, entrar√°s al Dashboard y ver√°s los datos aislados del esquema "tesla".7. Soluci√≥n de Errores ComunesS√≠ntomaCausa ProbableSoluci√≥nError "Bad Request (400)"El dominio tesla.localhost no est√° en ALLOWED_HOSTS del backend.Revisa el archivo .env en la ra√≠z y aseg√∫rate de que incluya tesla.localhost. Reinicia docker (docker-compose restart).Login exitoso pero vuelve al loginLas cookies no se est√°n guardando.Aseg√∫rate de usar http:// y no https:// en local. El par√°metro AUTH_COOKIE_SECURE en settings.py depende de DEBUG=True. Revisa que .env tenga DEBUG=True.Error de conexi√≥n a BDEl contenedor web intenta conectar a localhost en vez de db.Revisa .env. DB_HOST debe ser db (el nombre del servicio en docker-compose), no localhost.Error CORS en consolaEl frontend no tiene permiso para hablar con el back.Revisa settings.py. CORS_ALLOWED_ORIGINS debe incluir http://tesla.localhost:5173.
